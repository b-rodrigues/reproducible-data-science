# Setting up Nix and Positron

## Introduction

Nix officially supports only macOS and Linux distributions. 
Windows is technically supported via WSL2, since it runs a Linux kernel underneath. 
Practically, this means you can treat Linux distributions and Windows (via WSL2) as one system, 
and macOS as a separate system.

If you plan to use Nix on Windows, WSL2 must be installed and running first. 
An advantage of using WSL2 is isolation: any existing tools you have installed on Windows such as 
R, RStudio, Python, `uv`, etc., won’t interfere with Nix, allowing you to use it freely.

On Linux and macOS, however, pre-installed tools can conflict with Nix-managed tools. 
For example, environment managers like `uv` or manually installed R/Python versions may interfere 
with Nix environments. Ideally, you would let Nix manage all your tools, 
but completely removing existing installations of tools is often impractical especially if
the machine you will be using to follow along is also the machine you use for work.

But I do highly recommend setting up Nix to manage everything, at least once you feel comfortable
enough with Nix. However if you’re primarily an R user, you should be fine even with a system-level R installation,
and you could just set up Nix on the same machine and there shouldn’t be any issue (if there are it’ll only
be when trying to use Nix, not when trying to use your usual system-level installation of R).

Things can get more complicated with Python, especially if you have auto-loading of environments in your IDE.

If you prefer a safe way to experiment with Nix, you can set up a Linux virtual machine (but again, only
if you are already on Linux or macOS, and only if the machine you will be using already has R or Python).

On macOS, you could use [UTM](https://mac.getutm.app/)^[https://mac.getutm.app/] to set up such a machine. A simple
virtualization program for Linux is [Gnome Boxes](https://apps.gnome.org/Boxes/)^[https://apps.gnome.org/Boxes/].
If you use those, I recommend you then get the Lubuntu iso and install Lubuntu. It’s a lightweight
Ubuntu variant which is ideal for VMs. Give the VM 4 GB of RAM, and 20 GB of disk space.

Below I will provide instructions using `qemu`. But feel free to use any tool you prefer.

The script below will automatically install `qemu` and set up a Lubuntu VM for you with 4 GB of RAM 
on a persistent disk of 20 GB. 
First, create this script and save it somewhere as `boot_reprods_vm.sh`:

```bash
#!/usr/bin/env bash

# Directory for VM
VM_DIR="$HOME/lubuntu-vm"
mkdir -p "$VM_DIR"
DISK="$VM_DIR/lubuntu.qcow2"

# Install QEMU if missing
if ! command -v qemu-system-x86_64 &>/dev/null && ! command -v qemu-system-aarch64 &>/dev/null; then
  echo "QEMU not found, installing..."
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    if ! command -v brew &>/dev/null; then
      echo "Homebrew not found. Install Homebrew first: https://brew.sh/"
      exit 1
    fi
    brew install qemu
  elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Detect Linux distro
    if [ -f /etc/os-release ]; then
      . /etc/os-release
      case "$ID" in
        ubuntu|debian)
          sudo apt update && sudo apt install -y qemu qemu-kvm
          ;;
        fedora)
          sudo dnf install -y qemu-kvm
          ;;
        arch)
          sudo pacman -Sy --noconfirm qemu
          ;;
        *)
          echo "Unsupported Linux distro: $ID"
          exit 1
          ;;
      esac
    else
      echo "Cannot detect Linux distro. Please install QEMU manually."
      exit 1
    fi
  else
    echo "Unsupported OS: $OSTYPE"
    exit 1
  fi
fi

# Create persistent disk if missing
[ ! -f "$DISK" ] && qemu-img create -f qcow2 "$DISK" 20G

# Detect architecture
ARCH=$(uname -m)

# Download ISO if missing and boot VM
if [ "$ARCH" = "x86_64" ]; then
  ISO="$VM_DIR/lubuntu.iso"
  [ ! -f "$ISO" ] && curl -L -o "$ISO" https://cdimage.ubuntu.com/lubuntu/releases/24.04/release/lubuntu-24.04-desktop-amd64.iso
  qemu-system-x86_64 -enable-kvm -m 4096 -hda "$DISK" -cdrom "$ISO" -boot c
elif [ "$ARCH" = "arm64" ]; then
  ISO="$VM_DIR/lubuntu-arm64.iso"
  [ ! -f "$ISO" ] && curl -L -o "$ISO" https://cdimage.ubuntu.com/lubuntu/releases/24.04/release/lubuntu-24.04-desktop-arm64.iso
  qemu-system-aarch64 -accel hvf -machine virt -cpu cortex-a72 -m 4096 -hda "$DISK" -cdrom "$ISO" -boot c
else
  echo "Unsupported architecture: $ARCH"
  exit 1
fi
```

Make it executable:

```bash
chmod +x /path/to/script/boot_reprods_vm.sh
```

and now run the script:

```bash
/path/to/script/boot_reprods_vm.sh
```

On first run, this will download the `.iso` of Lubuntu and set up the vm for you. 
Install Lubuntu by following the instructions.
It’s quite easy. On subsequent runs, you will be able to just login into Lubuntu as usual and use
it to safely experiment with Nix!

## Windows pre-requisites

If you are on Windows, you need the Windows Subsystem for Linux 2 (WSL2) to run
Nix. If you are on a recent version of Windows 10 or 11, you can simply run this
as an administrator in PowerShell:

```bash
wsl --install
```

You can find further installation notes at [this official Microsoft
documentation](https://learn.microsoft.com/en-us/windows/wsl/install).

We recommend to activate systemd in Ubuntu WSL2, mainly because this supports
other users than `root` running Nix. To set this up, please do as outlined
in [the official Microsoft WSL documentation](https://learn.microsoft.com/en-us/windows/wsl/systemd#how-to-enable-systemd):

```sh
# in WSL2 Ubuntu shell

sudo -i
nano /etc/wsl.conf
```

This will open the `/etc/wsl.conf` in a nano, a command
line text editor. Add the following line:

```ini
[boot]
systemd=true
```

Save the file with CTRL-O and then quit nano with CTRL-X.
Then, type the following line in powershell:

```bash
wsl --shutdown
```

and then relaunch WSL (Ubuntu) from the start menu.

Then, you can follow the instructions for Linux.

## Determinate Nix

Installing (and uninstalling) Nix is quite simple, thanks to the installer from
[Determinate Systems](https://determinate.systems/posts/determinate-nix-installer),
a company that provides services and tools built on Nix.

Do not use your operating system’s package manager to install Nix. Instead,
simply open a terminal and run the following line (on Windows, if you cannot or
have decided not to activate systemd, then you have to append `--init none` to
the command. You can find more details about this on [The Determinate Nix
Installer page](https://github.com/DeterminateSystems/nix-installer)):

```sh
curl --proto '=https' --tlsv1.2 -sSf \
    -L https://install.determinate.systems/nix | \
     sh -s -- install
```

This will install Nix in a matter of seconds! Restart the terminal (WSL or native
on Linux) and let's try our installation of Nix using so-called temporary shells.

## Temporary shells

You now have Nix installed; before continuing, it let’s see if everything works
(close all your terminals and reopen them) by dropping into a temporary shell
with a tool you likely have not installed on your machine.

Open a terminal and run:

```bash
which sl
```

you will likely see something like this:

```bash
which: no sl in ....
```

now run this:

```bash
nix-shell -p sl
```

and then wait for Nix to do its magic. Then, run again:

```bash
which sl
```

this time you should see something like:

```bash
/nix/store/cndqpx74312xkrrgp842ifinkd4cg89g-sl-5.05/bin/sl
```

This is the path to the `sl` binary installed through Nix. The path starts with
`/nix/store`: the *Nix store* is where all the software installed through Nix is
stored.

Now type `sl` and see what happens!

You can find the list of available packages
[here](https://search.nixos.org/packages?channel=unstable&from=0&size=50&sort=relevance&type=packages&query=).

## The rstats-on-nix Cache

Next, we install the `cachix` client and configure our `rstats-on-nix` cache:
this will install binary versions of many R packages which will speed up the
building process of environments:

```bash
nix-env -iA cachix -f https://cachix.org/api/v1/install
```

then use the cache:

```bash
cachix use rstats-on-nix
```

You only need to do this once per machine you want to use `{rix}` on. Many thanks
to [Cachix](https://www.cachix.org/) for sponsoring the `rstats-on-nix` cache!

`{rix}` also includes a function called `setup_cachix()` which will configure
the cache but it is recommended to use the `cachix` client instead. This is
because `setup_cachix()` will not edit the files that require admin/root
privileges and only edit the user-level files. This may not be enough depending
on how you installed Nix. Using the `cachix` client takes care of everything.
Use `setup_cachix()` when building a Docker image or if you somehow mess up the
configuration file (which should be located in `~/.config/nix.conf`).

On Linux, once Nix is installed, all the software that will be installed through
Nix will be saved to the `/nix` directory on the root partition. It is common
for Linux users to have a separate partition for `/`, which may be small.
Complete development environments built with Nix can take up much space, so if
the available space on your root partition is limited, we advise you to mount
the `/nix` folder on another partition with more space (for example, a secondary
hard drive). For this, edit `/etc/fstab` and add the following line at the end:

```ini
/home/path_to/nix /nix none bind 0 0
```

This will map `/nix` to `/home/path_to/nix` which can be on a larger partition.
If you have enough space on your root partition, you can ignore the above
instructions.

## direnv

`direnv` will automatically load Nix shells when you open a project managed by
Nix. This makes using Nix, especially with an editor (which we will configure in
the next section), much more seamless and easy. If you're using Windows, install
`direnv` in WSL, just like Nix and `cachix` before. To install `direnv` run this
command:

```bash
nix-env -f '<nixpkgs>' -iA direnv
```

Then, we highly recommend to install the `nix-direnv` extension:

```bash
nix-env -f '<nixpkgs>' -iA nix-direnv
```

It is not mandatory to use `nix-direnv` if you already have `direnv`, but it'll
make loading environments much faster and seamless.

Finally, if you haven't used `direnv` before, don't forget [this last
step](https://direnv.net/docs/hook.html) to make your terminal detected and load
`direnv` automatically. On WSL, need to add `eval "$(direnv hook bash)"` to a
file called `.bashrc`, which you can find in your *home/* directory (this is the
directory that contains your user's folder like *Downloads* and so on). This
file starts with a `.`, which means it is hidden. You need top open it in an
editor and add the line right at the bottom. If you're comfortable with the terminal,
you can do it right from WSL, if not, you can navigate to your WSL home directory
from a Windows file explorer by typing `\\wsl$` in the address bar, and then entering
the `ubuntu` directory. Inside, you'll see the `home/` directory, and inside a directory
named after your username. This is where `.bashrc` resides, and you can open it using
Notepad.

On macOS, you need to add `eval "$(direnv hook zsh)` inside of `.zshrc` instead.

## Installing and configuring an editor

### Positron and VS Code

For polyglot data science projects, the recommended editor is Positron.
Positron is a fork of VS Code tailored for data scientists, with first-class
support for both R and Python. It makes it straightforward to select the correct
interpreter for each project, whether managed by Nix or another solution. Being
cross-platform, the same setup works on macOS, Windows, and Linux. Since it is
based on VS Code, switching from VS Code to Positron is seamless.

Personally, I use Emacs, but Positron is more accessible for most users. If you
prefer, you can also configure **VS Code** directly; instructions are provided
below.

**Installing Positron:**

- Download and install the installer for your operating system.
- On Windows, even if Nix is installed under WSL, install the **Windows version**
  of Positron. It can interact with Nix on WSL via a plugin.
- In Positron, install the
  [direnv extension](https://github.com/direnv/direnv-vscode)^[https://github.com/direnv/direnv-vscode].
- On Windows, also install the
  [Open Remote extension](https://open-vsx.org/extension/kv9898/open-remote-wsl)^[https://open-vsx.org/extension/kv9898/open-remote-wsl].

**Using VS Code instead of Positron:**

- Add the
  [REditorSupport extension](https://marketplace.visualstudio.com/items?itemName=REditorSupport.r)^[https://marketplace.visualstudio.com/items?itemName=REditorSupport.r].
- Install the [Python extension](https://marketplace.visualstudio.com/items?itemName=ms-python.python)^[https://marketplace.visualstudio.com/items?itemName=ms-python.python].
- Add the `{languageserver}` R package to your projects as well (we'll see how in the next chapter).

### Emacs

For Emacs, configuration is minimal:

- Install the `direnv` package.
- Add `python` and `ess` for R support.

With this setup, opening a Nix-managed project automatically ensures Emacs uses the correct interpreter for that project
(assuming we add an `.envrc` file to the project; more on this later).

